<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>gcc源码分析：Loongarch编译gcc-12报错问题定位 | 李焕宇的博客</title><meta name="author" content="李焕宇"><meta name="copyright" content="李焕宇"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="问题背景 基础环境是gcc-8.5与binutils-2.30版本，为满足其他组的ollama升级需求，需引入高版本gcc  引入方式：基于欧拉的gcc-12编译为gcc-toolset-12，与基础环境gcc-8.5共存  gcc-12依赖binutils &gt; 2.31，已将欧拉的binutils-2.37编译为gcc-toolset-12-binutils  而gcc-toolset-1">
<meta property="og:type" content="article">
<meta property="og:title" content="gcc源码分析：Loongarch编译gcc-12报错问题定位">
<meta property="og:url" content="http://example.com/2025/09/25/gcc%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9ALoongarch%E7%BC%96%E8%AF%91gcc-12%E6%8A%A5%E9%94%99%E9%97%AE%E9%A2%98%E5%AE%9A%E4%BD%8D/index.html">
<meta property="og:site_name" content="李焕宇的博客">
<meta property="og:description" content="问题背景 基础环境是gcc-8.5与binutils-2.30版本，为满足其他组的ollama升级需求，需引入高版本gcc  引入方式：基于欧拉的gcc-12编译为gcc-toolset-12，与基础环境gcc-8.5共存  gcc-12依赖binutils &gt; 2.31，已将欧拉的binutils-2.37编译为gcc-toolset-12-binutils  而gcc-toolset-1">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/biubiubiu.gif">
<meta property="article:published_time" content="2025-09-25T08:18:07.000Z">
<meta property="article:modified_time" content="2025-09-26T07:21:14.266Z">
<meta property="article:author" content="李焕宇">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/biubiubiu.gif"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "gcc源码分析：Loongarch编译gcc-12报错问题定位",
  "url": "http://example.com/2025/09/25/gcc%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9ALoongarch%E7%BC%96%E8%AF%91gcc-12%E6%8A%A5%E9%94%99%E9%97%AE%E9%A2%98%E5%AE%9A%E4%BD%8D/",
  "image": "http://example.com/images/biubiubiu.gif",
  "datePublished": "2025-09-25T08:18:07.000Z",
  "dateModified": "2025-09-26T07:21:14.266Z",
  "author": [
    {
      "@type": "Person",
      "name": "李焕宇",
      "url": "http://example.com"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2025/09/25/gcc%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9ALoongarch%E7%BC%96%E8%AF%91gcc-12%E6%8A%A5%E9%94%99%E9%97%AE%E9%A2%98%E5%AE%9A%E4%BD%8D/index.html"><link rel="preconnect"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/pluginsSrc/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: '/pluginsSrc/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'gcc源码分析：Loongarch编译gcc-12报错问题定位',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">李焕宇的博客</span></a><a class="nav-page-title" href="/"><span class="site-name">gcc源码分析：Loongarch编译gcc-12报错问题定位</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"></div></nav><div id="post-info"><h1 class="post-title">gcc源码分析：Loongarch编译gcc-12报错问题定位</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-09-25T08:18:07.000Z" title="发表于 2025-09-25 16:18:07">2025-09-25</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-09-26T07:21:14.266Z" title="更新于 2025-09-26 15:21:14">2025-09-26</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="问题背景"><a href="#问题背景" class="headerlink" title="问题背景"></a>问题背景</h1><ul>
<li><p>基础环境是<code>gcc-8.5</code>与<code>binutils-2.30</code>版本，为满足其他组的<code>ollama</code>升级需求，需引入高版本<code>gcc</code></p>
</li>
<li><p>引入方式：基于欧拉的<code>gcc-12</code>编译为<code>gcc-toolset-12</code>，与基础环境<code>gcc-8.5</code>共存</p>
</li>
<li><p><code>gcc-12</code>依赖<code>binutils &gt; 2.31</code>，已将欧拉的<code>binutils-2.37</code>编译为<code>gcc-toolset-12-binutils</code></p>
</li>
<li><p>而<code>gcc-toolset-12</code>编译过程中，两个架构报错：</p>
<ul>
<li>sw架构补丁冲突，已向欧拉提<a target="_blank" rel="noopener" href="https://gitee.com/src-openeuler/gcc-12/pulls/29">PR</a></li>
<li>Loongarch架构报汇编器不识别参数：<code>Error: unrecognized option -#lp64</code></li>
</ul>
</li>
</ul>
<p>本篇通过分析<code>gcc</code>源码，对<code>loongarch</code>架构的编译报错问题展开定位。</p>
<h1 id="初步分析"><a href="#初步分析" class="headerlink" title="初步分析"></a>初步分析</h1><h2 id="先获取报错位置"><a href="#先获取报错位置" class="headerlink" title="先获取报错位置"></a>先获取报错位置</h2><p>首先从<code>koji</code>中查看编译报错信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">+ ../configure --disable-bootstrap --enable-languages=c,c++,fortran,lto --prefix=/opt/cqsoft/gcc-toolset-12/root/usr --mandir=/opt/cqsoft/gcc-toolset-12/root/usr/share/man --infodir=/opt/cqsoft/gcc-toolset-12/root/usr/share/info --with-bugurl=https://gitee.com/src-openeuler/gcc/issues --enable-shared --enable-threads=posix --enable-checking=release --with-isl --with-as=/opt/cqsoft/gcc-toolset-12/root/usr/bin/as --with-ld=/opt/cqsoft/gcc-toolset-12/root/usr/bin/ld --disable-multilib --with-system-zlib --enable-__cxa_atexit --disable-libunwind-exceptions --enable-gnu-unique-object --enable-linker-build-id --with-gcc-major-version-only --enable-libstdcxx-backtrace --with-linker-hash-style=gnu --enable-plugin --enable-initfini-array --build=loongarch64-cysoft-linux --program-suffix=</span><br><span class="line">checking build system <span class="built_in">type</span>... loongarch64-cysoft-linux-gnu</span><br><span class="line">checking host system <span class="built_in">type</span>... loongarch64-cysoft-linux-gnu</span><br><span class="line">checking target system <span class="built_in">type</span>... loongarch64-cysoft-linux-gnu</span><br><span class="line">checking <span class="keyword">for</span> a BSD-compatible install... /usr/bin/install -c</span><br><span class="line">checking whether <span class="built_in">ln</span> works... <span class="built_in">yes</span></span><br><span class="line">checking whether <span class="built_in">ln</span> -s works... <span class="built_in">yes</span></span><br><span class="line">checking <span class="keyword">for</span> a sed that does not <span class="built_in">truncate</span> output... /usr/bin/sed</span><br><span class="line">checking <span class="keyword">for</span> gawk... gawk</span><br><span class="line">checking <span class="keyword">for</span> libatomic support... <span class="built_in">yes</span></span><br><span class="line">checking <span class="keyword">for</span> libitm support... <span class="built_in">yes</span></span><br><span class="line">checking <span class="keyword">for</span> libsanitizer support... <span class="built_in">yes</span></span><br><span class="line">checking <span class="keyword">for</span> libvtv support... <span class="built_in">yes</span></span><br><span class="line">checking <span class="keyword">for</span> libphobos support... <span class="built_in">yes</span></span><br><span class="line">checking <span class="keyword">for</span> gcc... gcc</span><br><span class="line">checking whether the C compiler works... no</span><br><span class="line">configure: error: <span class="keyword">in</span> `/builddir/build/BUILD/gcc-12.3.0/obj-loongarch64-cysoft-linux<span class="string">&#x27;:</span></span><br><span class="line"><span class="string">configure: error: C compiler cannot create executables</span></span><br><span class="line"><span class="string">See `config.log&#x27;</span> <span class="keyword">for</span> more details</span><br></pre></td></tr></table></figure>
<p><code>configure</code>阶段报错，<code>c</code>编译环境有问题，查看<code>config.log</code>中具体报错信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">// BUILD/gcc-12.3.0/obj-loongarch64-cysoft-linux/config.log</span><br><span class="line"></span><br><span class="line">Target: loongarch64-cysoft-linux</span><br><span class="line">Configured with: ../configure --enable-bootstrap --enable-languages=c,c++,fortran,lto --prefix=/usr --mandir=/usr/share/man --infodir=/usr/share/info --with-bugurl=https://bugzilla.openanolis.cn --enable-shared --enable-threads=posix --enable-checking=release --disable-multilib --with-system-zlib --enable-__cxa_atexit --disable-libunwind-exceptions --enable-gnu-unique-object --enable-linker-build-id --with-gcc-major-version-only --with-linker-hash-style=gnu --enable-plugin --enable-initfini-array --with-isl --disable-libmpx --enable-gnu-indirect-function --build=loongarch64-cysoft-linux --with-arch=loongarch64 --with-abi=lp64 --enable-tls --with-long-double-128 --enable-initfini-array --enable-gnu-indirect-function --disable-emultls --disable-multilib --with-linker-hash-style=gnu</span><br><span class="line">Thread model: posix</span><br><span class="line">gcc version 8.5.0 20210514 (8.5.0-22) (GCC)</span><br><span class="line">configure:4462: $? = 0</span><br><span class="line">configure:4451: gcc -V &gt;&amp;5</span><br><span class="line">gcc: error: unrecognized <span class="built_in">command</span> line option <span class="string">&#x27;-V&#x27;</span></span><br><span class="line">gcc: fatal error: no input files</span><br><span class="line">compilation terminated.</span><br><span class="line">configure:4462: $? = 1</span><br><span class="line">configure:4451: gcc -qversion &gt;&amp;5</span><br><span class="line">gcc: error: unrecognized <span class="built_in">command</span> line option <span class="string">&#x27;-qversion&#x27;</span>; did you mean <span class="string">&#x27;--version&#x27;</span>?</span><br><span class="line">gcc: fatal error: no input files</span><br><span class="line">compilation terminated.</span><br><span class="line">configure:4462: $? = 1</span><br><span class="line">configure:4482: checking whether the C compiler works</span><br><span class="line">configure:4504: gcc -O2 -g -Wall -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS -fexceptions -fstack-protector-strong -grecord-gcc-switches -fasynchronous-unwind-tables -fstack-clash-protection -O2 -Wp,-D_FORTIFY_SOURCE=2 -fstack-protector-strong -fPIE -Wl,-z,relro,-z,now   -Wl,-z,relro,-z,now conftest.c  &gt;&amp;5</span><br><span class="line">Assembler messages:</span><br><span class="line">Error: unrecognized option -#lp64</span><br></pre></td></tr></table></figure>
<p>可以看到，是汇编器报错：不识别参数<code>-#lp64</code></p>
<h2 id="最小化复现问题"><a href="#最小化复现问题" class="headerlink" title="最小化复现问题"></a>最小化复现问题</h2><p>既然是汇编器报错，那么在当前环境下，对任意的程序进行汇编（比如一个简单的<code>hello world</code>程序），都应不识别<code>-#lp64</code>。</p>
<p>注意，编译<code>gcc-toolset-12</code>使用的是<code>gcc-8.5</code>和<code>gcc-toolset-12-binutils</code>，所以复现时要先配置binutils路径：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># export PATH=/opt/cqsoft/gcc-toolset-12/root/usr/bin:$PATH     //激活 binutils2.37</span></span><br><span class="line"><span class="comment"># export LD_LIBRARY_PATH=/opt/cqsoft/gcc-toolset-12/root/usr/lib64:/opt/cqsoft/gcc-toolset-12/root/usr/lib:$LD_LIBRARY_PATH </span></span><br></pre></td></tr></table></figure>

<p>然后编译<code>a.c</code>程序，带上<code>-v</code>显示详细信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#  gcc a.c -v</span><br><span class="line">Using built-in specs.</span><br><span class="line">COLLECT_GCC=gcc</span><br><span class="line">COLLECT_LTO_WRAPPER=/usr/libexec/gcc/loongarch64-cysoft-linux/8/lto-wrapper</span><br><span class="line">Target: loongarch64-cysoft-linux</span><br><span class="line">Configured with: ../configure --enable-bootstrap --enable-languages=c,c++,fortran,lto --prefix=/usr --mandir=/usr/share/man --infodir=/usr/share/info --with-bugurl=https://bugzilla.openanolis.cn --enable-shared --enable-threads=posix --enable-checking=release --disable-multilib --with-system-zlib --enable-__cxa_atexit --disable-libunwind-exceptions --enable-gnu-unique-object --enable-linker-build-id --with-gcc-major-version-only --with-linker-hash-style=gnu --enable-plugin --enable-initfini-array --with-isl --disable-libmpx --enable-gnu-indirect-function --build=loongarch64-cysoft-linux --with-arch=loongarch64 --with-abi=lp64 --enable-tls --with-long-double-128 --enable-initfini-array --enable-gnu-indirect-function --disable-emultls --disable-multilib --with-linker-hash-style=gnu</span><br><span class="line">Thread model: posix</span><br><span class="line">gcc version 8.5.0 20210514 (8.5.0-22) (GCC)</span><br><span class="line">COLLECT_GCC_OPTIONS=&#x27;-v&#x27; &#x27;-mabi=lp64d&#x27; &#x27;-march=loongarch64&#x27; &#x27;-mfpu=64&#x27; &#x27;-msimd=none&#x27; &#x27;-mcmodel=normal&#x27; &#x27;-mtune=loongarch64&#x27;</span><br><span class="line"> /usr/libexec/gcc/loongarch64-cysoft-linux/8/cc1 -quiet -v -imultilib . a.c -quiet -dumpbase a.c -mabi=lp64d -march=loongarch64 -mfpu=64 -msimd=none -mcmodel=normal -mtune=loongarch64 -auxbase a -version -o /tmp/ccX53hBS.s</span><br><span class="line">GNU C17 (GCC) version 8.5.0 20210514 (8.5.0-22) (loongarch64-cysoft-linux)</span><br><span class="line">        compiled by GNU C version 8.5.0 20210514 (8.5.0-22), GMP version 6.2.0, MPFR version 3.1.6-p2, MPC version 1.1.0, isl version isl-0.16.1-GMP</span><br><span class="line"></span><br><span class="line">GGC heuristics: --param ggc-min-expand=100 --param ggc-min-heapsize=131072</span><br><span class="line">ignoring nonexistent directory &quot;/usr/lib/gcc/loongarch64-cysoft-linux/8/include-fixed&quot;</span><br><span class="line">ignoring nonexistent directory &quot;/usr/lib/gcc/loongarch64-cysoft-linux/8/../../../../loongarch64-cysoft-linux/include&quot;</span><br><span class="line">#include &quot;...&quot; search starts here:</span><br><span class="line">#include &lt;...&gt; search starts here:</span><br><span class="line"> /usr/lib/gcc/loongarch64-cysoft-linux/8/include</span><br><span class="line"> /usr/local/include</span><br><span class="line"> /usr/include</span><br><span class="line">End of search list.</span><br><span class="line">GNU C17 (GCC) version 8.5.0 20210514 (8.5.0-22) (loongarch64-cysoft-linux)</span><br><span class="line">        compiled by GNU C version 8.5.0 20210514 (8.5.0-22), GMP version 6.2.0, MPFR version 3.1.6-p2, MPC version 1.1.0, isl version isl-0.16.1-GMP</span><br><span class="line"></span><br><span class="line">GGC heuristics: --param ggc-min-expand=100 --param ggc-min-heapsize=131072</span><br><span class="line">Compiler executable checksum: b3f4f4b812693bc737d7c81921cdc35a</span><br><span class="line">COLLECT_GCC_OPTIONS=&#x27;-v&#x27; &#x27;-mabi=lp64d&#x27; &#x27;-march=loongarch64&#x27; &#x27;-mfpu=64&#x27; &#x27;-msimd=none&#x27; &#x27;-mcmodel=normal&#x27; &#x27;-mtune=loongarch64&#x27;</span><br><span class="line"> as -v -mabi=lp64 -o /tmp/ccTDvrpp.o /tmp/ccX53hBS.s</span><br><span class="line">GNU assembler version 2.37 (loongarch64-cysoft-linux) using BFD version (GNU Binutils) 2.37</span><br><span class="line">Assembler messages:</span><br><span class="line">Error: unrecognized option -#lp64</span><br></pre></td></tr></table></figure>

<p>最后是相同的报错信息：<code>unrecognized option -#lp64</code>，问题得以复现。</p>
<p>注意到汇编命令<code>as -v -mabi=lp64 -o /tmp/ccTDvrpp.o /tmp/ccX53hBS.s</code>，其中参数<code>-mabi=lp64</code>是报错原因。</p>
<p>因此最小化复现操作是<code>as</code>命令带上<code>-mabi=lp64</code>参数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># as -v -mabi=lp64 -o /tmp/ccTDvrpp.o /tmp/ccX53hBS.s</span></span><br><span class="line">GNU assembler version 2.37 (loongarch64-cysoft-linux) using BFD version (GNU Binutils) 2.37</span><br><span class="line">Assembler messages:</span><br><span class="line">Error: unrecognized option -#lp64</span><br></pre></td></tr></table></figure>

<h2 id="环境对照"><a href="#环境对照" class="headerlink" title="环境对照"></a>环境对照</h2><p>一种自然的想法是看下基础环境的<code>binutils-2.30</code>是否识别该参数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&lt;mock-chroot&gt; sh-4.4# gcc a.c -v</span><br><span class="line">Using built-in specs.</span><br><span class="line">COLLECT_GCC=gcc</span><br><span class="line">COLLECT_LTO_WRAPPER=/usr/libexec/gcc/loongarch64-cysoft-linux/8/lto-wrapper</span><br><span class="line">Target: loongarch64-cysoft-linux</span><br><span class="line">Configured with: ../configure --enable-bootstrap --enable-languages=c,c++,fortran,lto --prefix=/usr --mandir=/usr/share/man --infodir=/usr/share/info --with-bugurl=https://bugzilla.openanolis.cn --enable-shared --enable-threads=posix --enable-checking=release --disable-multilib --with-system-zlib --enable-__cxa_atexit --disable-libunwind-exceptions --enable-gnu-unique-object --enable-linker-build-id --with-gcc-major-version-only --with-linker-hash-style=gnu --enable-plugin --enable-initfini-array --with-isl --disable-libmpx --enable-gnu-indirect-function --build=loongarch64-cysoft-linux --with-arch=loongarch64 --with-abi=lp64 --enable-tls --with-long-double-128 --enable-initfini-array --enable-gnu-indirect-function --disable-emultls --disable-multilib --with-linker-hash-style=gnu</span><br><span class="line">Thread model: posix</span><br><span class="line">gcc version 8.5.0 20210514 (8.5.0-22) (GCC)</span><br><span class="line">COLLECT_GCC_OPTIONS=<span class="string">&#x27;-v&#x27;</span> <span class="string">&#x27;-mabi=lp64d&#x27;</span> <span class="string">&#x27;-march=loongarch64&#x27;</span> <span class="string">&#x27;-mfpu=64&#x27;</span> <span class="string">&#x27;-msimd=none&#x27;</span> <span class="string">&#x27;-mcmodel=normal&#x27;</span> <span class="string">&#x27;-mtune=loongarch64&#x27;</span></span><br><span class="line"> /usr/libexec/gcc/loongarch64-cysoft-linux/8/cc1 -quiet -v -imultilib . a.c -quiet -dumpbase a.c -mabi=lp64d -march=loongarch64 -mfpu=64 -msimd=none -mcmodel=normal -mtune=loongarch64 -auxbase a -version -o /tmp/cc4X5VBS.s</span><br><span class="line">GNU C17 (GCC) version 8.5.0 20210514 (8.5.0-22) (loongarch64-cysoft-linux)</span><br><span class="line">        compiled by GNU C version 8.5.0 20210514 (8.5.0-22), GMP version 6.2.0, MPFR version 3.1.6-p2, MPC version 1.1.0, isl version isl-0.16.1-GMP</span><br><span class="line"></span><br><span class="line">GGC heuristics: --param ggc-min-expand=100 --param ggc-min-heapsize=131072</span><br><span class="line">ignoring nonexistent directory <span class="string">&quot;/usr/lib/gcc/loongarch64-cysoft-linux/8/include-fixed&quot;</span></span><br><span class="line">ignoring nonexistent directory <span class="string">&quot;/usr/lib/gcc/loongarch64-cysoft-linux/8/../../../../loongarch64-cysoft-linux/include&quot;</span></span><br><span class="line"><span class="comment">#include &quot;...&quot; search starts here:</span></span><br><span class="line"><span class="comment">#include &lt;...&gt; search starts here:</span></span><br><span class="line"> /usr/lib/gcc/loongarch64-cysoft-linux/8/include</span><br><span class="line"> /usr/local/include</span><br><span class="line"> /usr/include</span><br><span class="line">End of search list.</span><br><span class="line">GNU C17 (GCC) version 8.5.0 20210514 (8.5.0-22) (loongarch64-cysoft-linux)</span><br><span class="line">        compiled by GNU C version 8.5.0 20210514 (8.5.0-22), GMP version 6.2.0, MPFR version 3.1.6-p2, MPC version 1.1.0, isl version isl-0.16.1-GMP</span><br><span class="line"></span><br><span class="line">GGC heuristics: --param ggc-min-expand=100 --param ggc-min-heapsize=131072</span><br><span class="line">Compiler executable checksum: b3f4f4b812693bc737d7c81921cdc35a</span><br><span class="line">COLLECT_GCC_OPTIONS=<span class="string">&#x27;-v&#x27;</span> <span class="string">&#x27;-mabi=lp64d&#x27;</span> <span class="string">&#x27;-march=loongarch64&#x27;</span> <span class="string">&#x27;-mfpu=64&#x27;</span> <span class="string">&#x27;-msimd=none&#x27;</span> <span class="string">&#x27;-mcmodel=normal&#x27;</span> <span class="string">&#x27;-mtune=loongarch64&#x27;</span></span><br><span class="line"> as -v -mabi=lp64 -o /tmp/cckjYHjS.o /tmp/cc4X5VBS.s</span><br><span class="line">GNU assembler version 2.30 (loongarch64-cysoft-linux) using BFD version version 2.30-130.cq24</span><br><span class="line">COMPILER_PATH=/usr/libexec/gcc/loongarch64-cysoft-linux/8/:/usr/libexec/gcc/loongarch64-cysoft-linux/8/:/usr/libexec/gcc/loongarch64-cysoft-linux/:/usr/lib/gcc/loongarch64-cysoft-linux/8/:/usr/lib/gcc/loongarch64-cysoft-linux/</span><br><span class="line">LIBRARY_PATH=/usr/lib/gcc/loongarch64-cysoft-linux/8/:/usr/lib/gcc/loongarch64-cysoft-linux/8/../../../../lib64/:/lib64/../lib64/:/usr/lib64/../lib64/:/usr/lib/gcc/loongarch64-cysoft-linux/8/../../../:/lib64/:/usr/lib64/</span><br><span class="line">COLLECT_GCC_OPTIONS=<span class="string">&#x27;-v&#x27;</span> <span class="string">&#x27;-mabi=lp64d&#x27;</span> <span class="string">&#x27;-march=loongarch64&#x27;</span> <span class="string">&#x27;-mfpu=64&#x27;</span> <span class="string">&#x27;-msimd=none&#x27;</span> <span class="string">&#x27;-mcmodel=normal&#x27;</span> <span class="string">&#x27;-mtune=loongarch64&#x27;</span></span><br><span class="line"> /usr/libexec/gcc/loongarch64-cysoft-linux/8/collect2 -plugin /usr/libexec/gcc/loongarch64-cysoft-linux/8/liblto_plugin.so -plugin-opt=/usr/libexec/gcc/loongarch64-cysoft-linux/8/lto-wrapper -plugin-opt=-fresolution=/tmp/ccE8YVsx.res -plugin-opt=-pass-through=-lgcc -plugin-opt=-pass-through=-lgcc_s -plugin-opt=-pass-through=-lc -plugin-opt=-pass-through=-lgcc -plugin-opt=-pass-through=-lgcc_s --build-id --no-add-needed --eh-frame-hdr --hash-style=gnu -m elf64loongarch -dynamic-linker /lib64/ld.so.1 /usr/lib/gcc/loongarch64-cysoft-linux/8/../../../../lib64/crt1.o /usr/lib/gcc/loongarch64-cysoft-linux/8/../../../../lib64/crti.o /usr/lib/gcc/loongarch64-cysoft-linux/8/crtbegin.o -L/usr/lib/gcc/loongarch64-cysoft-linux/8 -L/usr/lib/gcc/loongarch64-cysoft-linux/8/../../../../lib64 -L/lib64/../lib64 -L/usr/lib64/../lib64 -L/usr/lib/gcc/loongarch64-cysoft-linux/8/../../.. -L/lib64 -L/usr/lib64 /tmp/cckjYHjS.o -lgcc --as-needed -lgcc_s --no-as-needed -lc -lgcc --as-needed -lgcc_s --no-as-needed /usr/lib/gcc/loongarch64-cysoft-linux/8/crtend.o /usr/lib/gcc/loongarch64-cysoft-linux/8/../../../../lib64/crtn.o</span><br><span class="line">COLLECT_GCC_OPTIONS=<span class="string">&#x27;-v&#x27;</span> <span class="string">&#x27;-mabi=lp64d&#x27;</span> <span class="string">&#x27;-march=loongarch64&#x27;</span> <span class="string">&#x27;-mfpu=64&#x27;</span> <span class="string">&#x27;-msimd=none&#x27;</span> <span class="string">&#x27;-mcmodel=normal&#x27;</span> <span class="string">&#x27;-mtune=loongarch64&#x27;</span></span><br></pre></td></tr></table></figure>
<p>显然，<code>gcc</code>传给汇编器的参数始终是一样的，但<code>binutils-2.30</code>识别参数<code>-mabi=lp64</code>。</p>
<p><strong>初步分析结论</strong>：<code>gcc-8.5</code>给汇编器传<code>abi</code>参数<code>lp64</code>，不同版本的<code>binutils</code>对<code>abi</code>的支持是不一样的，<code>gcc-12</code>依赖的<code>binutils-2.37</code>不支持<code>lp64</code>参数，导致编译报错。</p>
<h1 id="网上搜索解决方案"><a href="#网上搜索解决方案" class="headerlink" title="网上搜索解决方案"></a>网上搜索解决方案</h1><h2 id="查询loongarch对abi的支持"><a href="#查询loongarch对abi的支持" class="headerlink" title="查询loongarch对abi的支持"></a>查询loongarch对abi的支持</h2><p>查询《龙芯架构工具链约定》，<a target="_blank" rel="noopener" href="https://loongson.github.io/LoongArch-Documentation/LoongArch-toolchain-conventions-CN.html#_%E7%BC%96%E8%AF%91%E5%99%A8%E5%91%BD%E4%BB%A4%E8%A1%8C%E9%80%89%E9%A1%B9">编译器命令行选项</a> 列举了<code>-mabi</code>可配置的参数：<br><img src="https://github.com/yu410621/picx-images-hosting/raw/master/image.wixfmzz7w.webp"></p>
<p>每个选项的详细信息如下：</p>
<p><img src="https://github.com/yu410621/picx-images-hosting/raw/master/loongarch-abi.2yyq3ogu4f.webp" alt="ABI"></p>
<p>显然不支持<code>lp64</code>。</p>
<h2 id="搜索相关不支持的问题"><a href="#搜索相关不支持的问题" class="headerlink" title="搜索相关不支持的问题"></a>搜索相关不支持的问题</h2><p>容易查到这样一个<a target="_blank" rel="noopener" href="https://sourceware.org/bugzilla/show_bug.cgi?id=29059#c0">PR</a>：<br><img src="https://github.com/yu410621/picx-images-hosting/raw/master/image.7snkztrjq7.webp"></p>
<ul>
<li><p><strong>GCC 的演进</strong>：作为上游的新版本，<code>gcc-12</code> 开始采用并向汇编器 <code>gas(GNU Assembler)</code> 传递更规范、更精确的 <code>ABI</code> 参数 <code>-mabi=lp64d</code>。</p>
</li>
<li><p><strong>Binutils 的滞后</strong>：当时已发布的 <code>binutils 2.38</code> 尚未更新，其汇编器 <code>gas</code> 还不识别新的 <code>lp64d</code> 参数，只认识旧的、非官方的 <code>-mabi=lp64</code> 写法。</p>
</li>
<li><p><strong>导致的冲突</strong>：这导致 <code>gcc-12</code> 无法与 <code>binutils 2.38</code> 直接配合使用，在编译时会因参数不识别而失败。</p>
</li>
<li><p><strong>解决方案</strong>：因此，补丁旨在更新 <code>binutils</code>，使其能够识别 <code>lp64d</code> 等新版 <code>ABI</code> 参数，从而与 <code>gcc-12</code> 的标准对齐。</p>
</li>
</ul>
<p>可见，<code>lp64</code>是旧版本的参数，而<code>lp64d</code>是新版本的参数。</p>
<p><code>gcc-8.5</code>传给<code>gcc-toolset-12-binutils</code>的是旧参数<code>-mabi=lp64</code>，工具链不配套，<code>gcc-12</code>才传新参数。</p>
<h1 id="分析解决方案"><a href="#分析解决方案" class="headerlink" title="分析解决方案"></a>分析解决方案</h1><p>问题在于如何给<code>gcc-toolset-12-binutils</code>传<code>-mabi=lp64d</code>参数，两种方法：</p>
<ul>
<li>方法1：拿欧拉的<code>gcc-12</code>来编译<code>gcc-toolset-12</code></li>
<li>方法2：修改当前的<code>gcc-8.5</code>传参改为<code>lp64d</code></li>
</ul>
<p>安装欧拉的<code>gcc-12</code>可能疲于处理依赖问题，依赖深度不确定。而修改<code>gcc-8.5</code>编译出龙芯专用的传参<code>lp64d</code>版本，没有任何依赖问题。</p>
<h1 id="gcc源码分析"><a href="#gcc源码分析" class="headerlink" title="gcc源码分析"></a>gcc源码分析</h1><h2 id="gcc在编译中的作用"><a href="#gcc在编译中的作用" class="headerlink" title="gcc在编译中的作用"></a>gcc在编译中的作用</h2><p><code>gcc</code> 命令本身并不是一个单一、庞大的编译程序，而是一个驱动程序。</p>
<p>其核心职责是解析用户提供的命令行参数，并根据这些参数去协调、调用一系列独立的后台程序，以协作完成从源代码到最终可执行文件的整个转换过程。</p>
<p>从上文的 <code>gcc a.c -v</code> 命令输出可以看到，依次执行了：</p>
<ul>
<li><p><code>/usr/libexec/gcc/loongarch64-cysoft-linux/8/cc1 ...</code></p>
</li>
<li><p><code>as -v -mabi=lp64 -o /tmp/cckjYHjS.o /tmp/cc4X5VBS.s</code></p>
</li>
<li><p><code>/usr/libexec/gcc/loongarch64-cysoft-linux/8/collect2 ...</code></p>
</li>
</ul>
<p>这些命令进行编译、汇编和链接。</p>
<p><code>gcc</code> 在其中的作用就是为这些命令组织参数，然后派生进程执行具体的编译过程。</p>
<h2 id="as命令的调用栈"><a href="#as命令的调用栈" class="headerlink" title="as命令的调用栈"></a>as命令的调用栈</h2><blockquote>
<p>问题出现在龙芯架构，但可以先在本地环境调试，因为基本逻辑是一样的。最后在龙芯上修改验证即可。</p>
</blockquote>
<blockquote>
<p>所以以下调试过程是在<code>x86_64</code>环境。</p>
</blockquote>
<blockquote>
<p>因为<code>lp64</code>是龙芯架构独有的，而<code>x86_64</code>传了参数<code>--64</code>，所以分析<code>--64</code>来源也就知道<code>lp64</code>是怎么来的了。</p>
</blockquote>
<p>通过 <code>as</code> 栈获取关键代码路径，进而分析 <code>--64</code> 参数的传递过程。</p>
<p>先配置一下 <code>gdb</code> 启动脚本 <code>~/.gdbinit</code> ，每次启动 <code>gdb</code> 时会读该文件中的配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义 &#x27;pargv&#x27; 命令，用于打印以 NULL 结尾的参数数组 (argv)。</span></span><br><span class="line"><span class="comment"># arg0 表示 gdb 自定义命令的第一个位置参数。</span></span><br><span class="line"><span class="comment"># 用法: pargv argv</span></span><br><span class="line">define pargv</span><br><span class="line">  <span class="built_in">set</span> <span class="variable">$i</span> = 0</span><br><span class="line">  <span class="keyword">while</span> <span class="variable">$arg0</span>[<span class="variable">$i</span>]</span><br><span class="line">    <span class="built_in">print</span> <span class="variable">$arg0</span>[<span class="variable">$i</span>]</span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$i</span> = <span class="variable">$i</span> + 1</span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 gdb 时提示 .gdbinit 文件已成功加载</span></span><br><span class="line"><span class="built_in">echo</span> GDB: Custom commands from ~/.gdbinit loaded.\n</span><br></pre></td></tr></table></figure>
<p>该文件中自定义了一个 <code>pargv</code> 命令，方便调试时打印参数列表。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# gdb gcc</span><br><span class="line">GNU gdb (GDB) 9.2</span><br><span class="line">Copyright (C) 2020 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.</span><br><span class="line">Type <span class="string">&quot;show copying&quot;</span> and <span class="string">&quot;show warranty&quot;</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">&quot;x86_64-cysoft-linux-gnu&quot;</span>.</span><br><span class="line">Type <span class="string">&quot;show configuration&quot;</span> <span class="keyword">for</span> configuration details.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span><br><span class="line">Find the GDB manual and other documentation resources online at:</span><br><span class="line">    &lt;http://www.gnu.org/software/gdb/documentation/&gt;.</span><br><span class="line"></span><br><span class="line">For <span class="built_in">help</span>, <span class="built_in">type</span> <span class="string">&quot;help&quot;</span>.</span><br><span class="line">Type <span class="string">&quot;apropos word&quot;</span> to search <span class="keyword">for</span> commands related to <span class="string">&quot;word&quot;</span>...</span><br><span class="line">GDB: Custom commands from ~/.gdbinit loaded.</span><br><span class="line">Reading symbols from gcc...</span><br><span class="line">Reading symbols from /usr/lib/debug/usr/bin/gcc-8.5.0-21.cq24.x86_64.debug...</span><br><span class="line">(gdb) b vfork</span><br><span class="line">Breakpoint 1 at 0x1ff60</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>

<p>启动<code>gdb</code>后，设置<code>vfork</code>断点，第一次调用时是准备执行<code>cc1</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(gdb) r a.c -v</span><br><span class="line">Starting program: /usr/bin/gcc a.c -v</span><br><span class="line">使用内建 specs。</span><br><span class="line">COLLECT_GCC=/usr/bin/gcc</span><br><span class="line">COLLECT_LTO_WRAPPER=/usr/libexec/gcc/x86_64-cysoft-linux/8/lto-wrapper</span><br><span class="line">OFFLOAD_TARGET_NAMES=nvptx-none</span><br><span class="line">OFFLOAD_TARGET_DEFAULT=1</span><br><span class="line">目标：x86_64-cysoft-linux</span><br><span class="line">配置为：../configure --enable-bootstrap --enable-languages=c,c++,fortran,lto --prefix=/usr --mandir=/usr/share/man --infodir=/usr/share/info --with-bugurl=https://bugzilla.openanolis.cn --enable-shared --enable-threads=posix --enable-checking=release --disable-multilib --with-system-zlib --enable-__cxa_atexit --disable-libunwind-exceptions --enable-gnu-unique-object --enable-linker-build-id --with-gcc-major-version-only --with-linker-hash-style=gnu --enable-plugin --enable-initfini-array --with-isl --disable-libmpx --enable-offload-targets=nvptx-none --without-cuda-driver --enable-gnu-indirect-function --enable-cet --with-tune=generic --with-arch_32=x86-64 --build=x86_64-cysoft-linux</span><br><span class="line">线程模型：posix</span><br><span class="line">gcc 版本 8.5.0 20210514 (8.5.0-21) (GCC) </span><br><span class="line">COLLECT_GCC_OPTIONS=<span class="string">&#x27;-v&#x27;</span> <span class="string">&#x27;-mtune=generic&#x27;</span> <span class="string">&#x27;-march=x86-64&#x27;</span></span><br><span class="line"> /usr/libexec/gcc/x86_64-cysoft-linux/8/cc1 -quiet -v a.c -quiet -dumpbase a.c -mtune=generic -march=x86-64 -auxbase a -version -o /tmp/ccO2vrZ5.s</span><br><span class="line"></span><br><span class="line">Breakpoint 1, vfork () at ../sysdeps/unix/sysv/linux/x86_64/vfork.S:28</span><br><span class="line">28	ENTRY (__vfork)</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>

<p><code>continue</code>继续，在第二次调用时准备执行<code>as</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line">[Detaching after vfork from child process 16016]</span><br><span class="line">GNU C17 (GCC) 版本 8.5.0 20210514 (8.5.0-21) (x86_64-cysoft-linux)</span><br><span class="line">	由 GNU C 版本 8.5.0 20210514 (8.5.0-21) 编译，GMP 版本 6.2.0，MPFR 版本 3.1.6-p2，MPC 版本 1.1.0，isl 版本 isl-0.16.1-GMP</span><br><span class="line"></span><br><span class="line">GGC 准则：--param ggc-min-expand=100 --param ggc-min-heapsize=131072</span><br><span class="line">忽略不存在的目录“/usr/lib/gcc/x86_64-cysoft-linux/8/include-fixed”</span><br><span class="line">忽略不存在的目录“/usr/lib/gcc/x86_64-cysoft-linux/8/../../../../x86_64-cysoft-linux/include”</span><br><span class="line"><span class="comment">#include &quot;...&quot; 搜索从这里开始：</span></span><br><span class="line"><span class="comment">#include &lt;...&gt; 搜索从这里开始：</span></span><br><span class="line"> /usr/lib/gcc/x86_64-cysoft-linux/8/include</span><br><span class="line"> /usr/local/include</span><br><span class="line"> /usr/include</span><br><span class="line">搜索列表结束。</span><br><span class="line">GNU C17 (GCC) 版本 8.5.0 20210514 (8.5.0-21) (x86_64-cysoft-linux)</span><br><span class="line">	由 GNU C 版本 8.5.0 20210514 (8.5.0-21) 编译，GMP 版本 6.2.0，MPFR 版本 3.1.6-p2，MPC 版本 1.1.0，isl 版本 isl-0.16.1-GMP</span><br><span class="line"></span><br><span class="line">GGC 准则：--param ggc-min-expand=100 --param ggc-min-heapsize=131072</span><br><span class="line">Compiler executable checksum: b2463cb3ca733c5bfc4061f9d3ffeef7</span><br><span class="line">COLLECT_GCC_OPTIONS=<span class="string">&#x27;-v&#x27;</span> <span class="string">&#x27;-mtune=generic&#x27;</span> <span class="string">&#x27;-march=x86-64&#x27;</span></span><br><span class="line"> as -v --64 -o /tmp/ccnuTmp7.o /tmp/ccO2vrZ5.s</span><br><span class="line"></span><br><span class="line">Breakpoint 1, vfork () at ../sysdeps/unix/sysv/linux/x86_64/vfork.S:28</span><br><span class="line">28	ENTRY (__vfork)</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>
<p>这时设置跟踪子进程，并设置断点<code>execvp</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(gdb) <span class="built_in">set</span> follow-fork-mode child </span><br><span class="line">(gdb) b execvp</span><br><span class="line">Breakpoint 2 at 0x7ffff76c91c0: file execvp.c, line 25.</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line">[Attaching after process 16011 vfork to child process 16728]</span><br><span class="line">[New inferior 2 (process 16728)]</span><br><span class="line">[Switching to process 16728]</span><br><span class="line"></span><br><span class="line">Thread 2.1 <span class="string">&quot;gcc&quot;</span> hit Breakpoint 2, __GI_execvp (file=0x55555575bfd0 <span class="string">&quot;as&quot;</span>, argv=0x555555761b48) at execvp.c:25</span><br><span class="line">25	&#123;</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>
<p>断到后查看栈和命令行参数(可用自定义的<code>pargv</code>命令)：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  __GI_execvp (file=0x55555575bfd0 &quot;as&quot;, argv=0x555555761b48) at execvp.c:25</span></span><br><span class="line"><span class="comment">#1  0x000055555548f5e4 in pex_unix_exec_child (obj=0x555555761d60, flags=&lt;optimized out&gt;, executable=0x55555575bfd0 &quot;as&quot;, </span></span><br><span class="line">    argv=0x555555761b48, <span class="built_in">env</span>=0x0, <span class="keyword">in</span>=0, out=1, errdes=2, toclose=-1, errmsg=0x7fffffffd678, err=0x7fffffffd724)</span><br><span class="line">    at ../../libiberty/pex-unix.c:670</span><br><span class="line"><span class="comment">#2  0x000055555548e6df in pex_run_in_environment (err=0x7fffffffd724, errname=0x0, orig_outname=0x0, env=0x0, argv=&lt;optimized out&gt;, </span></span><br><span class="line">    executable=&lt;optimized out&gt;, flags=3, obj=&lt;optimized out&gt;) at ../../libiberty/pex-common.c:344</span><br><span class="line"><span class="comment">#3  pex_run (obj=obj@entry=0x555555761d60, flags=3, executable=&lt;optimized out&gt;, argv=&lt;optimized out&gt;, </span></span><br><span class="line">    orig_outname=orig_outname@entry=0x0, errname=errname@entry=0x0, err=0x7fffffffd724) at ../../libiberty/pex-common.c:374</span><br><span class="line"><span class="comment">#4  0x0000555555426430 in execute () at ../../gcc/gcc.c:3196</span></span><br><span class="line"><span class="comment">#5  0x0000555555477c32 in driver::do_spec_on_infiles (this=0x7fffffffd970) at ../../gcc/gcc.c:8190</span></span><br><span class="line"><span class="comment">#6  0x000055555546a6aa in driver::main (this=0x7fffffffd970, argc=&lt;optimized out&gt;, argv=&lt;optimized out&gt;) at ../../gcc/gcc.c:7317</span></span><br><span class="line"><span class="comment">#7  0x000055555546a8cd in main (argc=3, argv=0x7fffffffda88) at ../../gcc/gcc-main.c:46</span></span><br><span class="line">(gdb) pargv argv</span><br><span class="line"><span class="variable">$1</span> = 0x55555575bfd0 <span class="string">&quot;as&quot;</span></span><br><span class="line"><span class="variable">$2</span> = 0x55555575bfe0 <span class="string">&quot;-v&quot;</span></span><br><span class="line"><span class="variable">$3</span> = 0x55555575bff0 <span class="string">&quot;--64&quot;</span></span><br><span class="line"><span class="variable">$4</span> = 0x55555575c000 <span class="string">&quot;-o&quot;</span></span><br><span class="line"><span class="variable">$5</span> = 0x55555575c010 <span class="string">&quot;/tmp/ccnuTmp7.o&quot;</span></span><br><span class="line"><span class="variable">$6</span> = 0x55555575c020 <span class="string">&quot;/tmp/ccO2vrZ5.s&quot;</span></span><br></pre></td></tr></table></figure>

<p>至此，在没阅读过 <code>gcc</code> 源码的情况下，用一点基本的 <code>gdb</code> 调试，从 <code>gcc</code> 庞大源码中获取到一条清晰的路径。</p>
<p>既然知道 <code>gcc</code> 是负责组织参数，并调用 <code>as</code> 执行汇编，那么调用栈可以分为“<strong>组织参数</strong>”和“<strong>调用执行</strong>”两部分。</p>
<p>而调用栈中正好有一个名为<code>execute ()</code>的函数，这似乎是一条清晰的分界线，所以<code>driver::do_spec_on_infiles</code>就成了分析参数来源的重点。</p>
<h2 id="driver-do-spec-on-infiles"><a href="#driver-do-spec-on-infiles" class="headerlink" title="driver::do_spec_on_infiles"></a><code>driver::do_spec_on_infiles</code></h2></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">李焕宇</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2025/09/25/gcc%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9ALoongarch%E7%BC%96%E8%AF%91gcc-12%E6%8A%A5%E9%94%99%E9%97%AE%E9%A2%98%E5%AE%9A%E4%BD%8D/">http://example.com/2025/09/25/gcc%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9ALoongarch%E7%BC%96%E8%AF%91gcc-12%E6%8A%A5%E9%94%99%E9%97%AE%E9%A2%98%E5%AE%9A%E4%BD%8D/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="http://example.com" target="_blank">李焕宇的博客</a>！</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="/images/biubiubiu.gif" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="/pluginsSrc/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="/pluginsSrc/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related full-width" href="/2025/09/25/hello-world/" title="Hello World"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Hello World</div></div><div class="info-2"><div class="info-item-1">Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub. Quick StartCreate a new post1$ hexo new &quot;My New Post&quot;  More info: Writing Run server1$ hexo server  More info: Server Generate static files1$ hexo generate  More info: Generating Deploy to remote sites1$ hexo deploy  More info: Deployment </div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/images/biubiubiu.gif" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">李焕宇</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">2</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/yu410621"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF"><span class="toc-number">1.</span> <span class="toc-text">问题背景</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%9D%E6%AD%A5%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">初步分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%88%E8%8E%B7%E5%8F%96%E6%8A%A5%E9%94%99%E4%BD%8D%E7%BD%AE"><span class="toc-number">2.1.</span> <span class="toc-text">先获取报错位置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%80%E5%B0%8F%E5%8C%96%E5%A4%8D%E7%8E%B0%E9%97%AE%E9%A2%98"><span class="toc-number">2.2.</span> <span class="toc-text">最小化复现问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%AF%B9%E7%85%A7"><span class="toc-number">2.3.</span> <span class="toc-text">环境对照</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BD%91%E4%B8%8A%E6%90%9C%E7%B4%A2%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">3.</span> <span class="toc-text">网上搜索解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2loongarch%E5%AF%B9abi%E7%9A%84%E6%94%AF%E6%8C%81"><span class="toc-number">3.1.</span> <span class="toc-text">查询loongarch对abi的支持</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E7%9B%B8%E5%85%B3%E4%B8%8D%E6%94%AF%E6%8C%81%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">3.2.</span> <span class="toc-text">搜索相关不支持的问题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">4.</span> <span class="toc-text">分析解决方案</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#gcc%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">5.</span> <span class="toc-text">gcc源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#gcc%E5%9C%A8%E7%BC%96%E8%AF%91%E4%B8%AD%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">5.1.</span> <span class="toc-text">gcc在编译中的作用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#as%E5%91%BD%E4%BB%A4%E7%9A%84%E8%B0%83%E7%94%A8%E6%A0%88"><span class="toc-number">5.2.</span> <span class="toc-text">as命令的调用栈</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#driver-do-spec-on-infiles"><span class="toc-number">5.3.</span> <span class="toc-text">driver::do_spec_on_infiles</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/25/gcc%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9ALoongarch%E7%BC%96%E8%AF%91gcc-12%E6%8A%A5%E9%94%99%E9%97%AE%E9%A2%98%E5%AE%9A%E4%BD%8D/" title="gcc源码分析：Loongarch编译gcc-12报错问题定位">gcc源码分析：Loongarch编译gcc-12报错问题定位</a><time datetime="2025-09-25T08:18:07.000Z" title="发表于 2025-09-25 16:18:07">2025-09-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/25/hello-world/" title="Hello World">Hello World</a><time datetime="2025-09-25T07:44:47.712Z" title="发表于 2025-09-25 15:44:47">2025-09-25</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By 李焕宇</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.0</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>